<?xml version="1.0" standalone="no"?>

<kickstart>


	<description>
	Your rabbitmq roll description here
	</description>

	<copyright>
	Copyright (c) 2000 - 2014 The Regents of the University of California.
	All rights reserved. Rocks(r) v6.1.1 www.rocksclusters.org
	
	</copyright>

	<changelog>
	$Log$
	</changelog>

	<package>rabbitmq</package>

    <post>
        /sbin/chkconfig rabbitmq-server on
        /usr/lib/rabbitmq/bin/rabbitmq-plugins enable rabbitmq_management

        # start the server and set up user credential
        /sbin/service rabbitmq-server start
        admin_pass=$(&lt; /dev/urandom tr -dc _A-Z-a-z-0-9 | head -c26)
        /usr/sbin/rabbitmqctl add_user rocks ${admin_pass}
        /usr/sbin/rabbitmqctl set_user_tags rocks administrator
        /usr/sbin/rabbitmqctl set_permissions -p / rocks ".*" ".*" ".*"
        /usr/sbin/rabbitmqctl delete_user guest
        echo "amqp://rocks:${admin_pass}@&Kickstart_PrivateHostname;:5672/%2F?connection_attempts=1000&amp;frame_max=64000&amp;heartbeat_interval=30" \
                                &gt; /opt/rocks/etc/rabbitmq.conf
        chmod 400 /opt/rocks/etc/rabbitmq.conf


        # adding rabbitmq to 411 so we push the password to the nodes
        echo "FILES_NOCOMMENT += /opt/rocks/etc/rabbitmq.conf" &gt;&gt; /var/411/Files.mk
        /usr/bin/make -C /var/411 411.mk
    </post>


</kickstart>
