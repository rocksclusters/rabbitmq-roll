<?xml version="1.0" standalone="no"?>

<kickstart>


	<description>
	Your rabbitmq roll description here
	</description>

	<copyright>
	Copyright (c) 2000 - 2014 The Regents of the University of California.
	All rights reserved. Rocks(r) v6.1.1 www.rocksclusters.org
	
	</copyright>

	<changelog>
	$Log$
	</changelog>

	<package>rabbitmq</package>
	<package>erlang</package>
	<package>rabbitmq-server</package>



<post>
        mkdir -p /etc/pki/rabbitmq

<file name="/etc/rabbitmq/rabbitmq.config" perms="644">
[
  {rabbit, [
     {ssl_listeners, [5671]},
     {ssl_options, [{cacertfile,"/etc/pki/rabbitmq/cacert.pem"},
                    {certfile,"/etc/pki/rabbitmq/cert.pem"},
                    {keyfile,"/etc/pki/rabbitmq/key.pem"},
                    {verify,verify_peer},
                    {fail_if_no_peer_cert,false}]}
   ]}
]. 
</file>

<file name="/etc/pki/rabbitmq/openssl.cnf" perms="600">
[ ca ]
default_ca = testca

[ testca ]
dir = .
certificate = $dir/cacert.pem
database = $dir/index.txt
new_certs_dir = $dir/certs
private_key = $dir/private/cakey.pem
serial = $dir/serial

default_crl_days = 7
default_days = 3650
default_md = sha1

policy = testca_policy
x509_extensions = certificate_extensions

[ testca_policy ]
commonName = supplied
stateOrProvinceName = optional
countryName = optional
emailAddress = optional
organizationName = optional
organizationalUnitName = optional

[ certificate_extensions ]
basicConstraints = CA:false

[ req ]
default_bits = 2048
default_keyfile = ./private/cakey.pem
default_md = sha1
prompt = yes
distinguished_name = root_ca_distinguished_name
x509_extensions = root_ca_extensions

[ root_ca_distinguished_name ]
commonName = hostname

[ root_ca_extensions ]
basicConstraints = CA:true
keyUsage = keyCertSign, cRLSign

[ client_ca_extensions ]
basicConstraints = CA:false
keyUsage = digitalSignature
extendedKeyUsage = 1.3.6.1.5.5.7.3.2

[ server_ca_extensions ]
basicConstraints = CA:false
keyUsage = keyEncipherment
extendedKeyUsage = 1.3.6.1.5.5.7.3.1
</file>

        cd /etc/pki/rabbitmq
        /usr/bin/openssl req -x509 -config /etc/pki/rabbitmq/openssl.cnf -newkey rsa:2048 -days 3650 \
            -out cacert.pem -keyout cakey.pem -outform PEM -subj /CN=MyCA/ -nodes
        /usr/bin/openssl req -newkey rsa:2048 -keyout key.pem -nodes -x509 -days 3650 -out cert.pem \
            -subj "/C=US/ST=CA/L=San Diego/O=UCSD/OU=SDSC/CN=&Kickstart_PublicHostname;"
        /bin/chmod 770 /etc/pki/rabbitmq
        /bin/chmod 660 /etc/pki/rabbitmq/*
        /bin/chown rabbitmq:rabbitmq /etc/pki/rabbitmq -R

        /sbin/chkconfig rabbitmq-server on
        /usr/lib/rabbitmq/bin/rabbitmq-plugins enable rabbitmq_management --offline

        # start the server and set up user credential
        /sbin/service rabbitmq-server start
        admin_pass=$(&lt; /dev/urandom tr -dc _A-Z-a-z-0-9 | head -c26)
        /usr/sbin/rabbitmqctl delete_vhost /
        /usr/sbin/rabbitmqctl add_user admin ${admin_pass} &amp;&amp; echo "${admin_pass}" &gt; /opt/rocks/etc/rabbitmq_admin.conf
        /usr/sbin/rabbitmqctl set_user_tags admin administrator
        /usr/sbin/rabbitmqctl delete_user guest
</post>


</kickstart>
